# R3 kintone js deployer

kintoneアプリカスタマイズのJavaScript/cssのデプロイをサポートするツールです。

rubyのスクリプトになっています。

## インストール

(1) ruby 2.0 以降をインストールしてください。

1.8系では動かないはずです。

Windows
http://rubyinstaller.org/

MaxOS X
OSに入ってるものでOK（バージョンが1.8でなければ）

(2) 以下の gem をインストールしてください。

```
gem install multipart-post
```

(3) deploy.rb をプロジェクトのディレクトリなどにコピーしてください。


## デプロイ設定の記述

このスクリプトには「デプロイ環境」の概念があります。デプロイ環境によりデプロイ先のアプリを切り替えることができます。
例えば「dev環境」「product環境」といった区分をつけることができます。
gusukuの「環境」と類似の考え方です。


(1) kintone接続アカウントの設定

.kintone.rb
という名前のファイルをカレントディレクトリに作成し、以下のように接続ユーザー名とパスワードを記述してください。

```ruby
KINTONE_USERNAME = 'Administrator'
KINTONE_PASSWORD = 'xxxxxxxx'
```

パスワードを記述しますので、このファイルの管理には注意してください。
（例えばgithubで世界中に公開してしまわないように！）


(2) デプロイするアプリとファイルの設定

deployfile.rb
という名前のファイルカレントディレクトリに作成し、設定を記述します。makefile的なものに相当します。

サンプルとして sample/deployfile.rb を参考にしてください。

以下の定数を定義します。

- APP_IDS
    - アプリケーションの名称から環境毎のapp IDへのマップ
    「アプリケーションの名称」は任意で構いません。

- DEPLOY_FILES
    - アプリケーションの名称からデプロイしたいファイルの配列へのマップ
    - JavaScriptとcssでそれぞれ定義します。
    - サンプルではどの環境でも同じファイルをデプロイする設定になっています。
    - 環境毎にデプロイするファイルを切り分けたい場合はそのようなコードを書けばOKです。
        以下の例では、環境がdevならば"開発用.js"をデプロイし、環境が本番なら"本番用.js"をデプロイします。

```ruby
DEPLOY_FILES = {
  "MyApp": {
      js: [ {"dev":"開発用.js", "product":"本番用.js"}[DEPLOY_ENV] ],
      css: []
  }
}
```

- KINTONE_SUBDOMAIN
    - デプロイ先のkintoneサブドメイン


## 起動方法

```sh
ruby deploy.rb [[環境] [アプリ名]]
```

[環境][アプリ名]を省略した場合、すべてのアプリがデフォルトの環境へデプロイされます。
デフォルトの環境の定義は deployfile.rb によります。
サンプルではデフォルトの環境は "dev" にっています。

[環境]を指定して[アプリ名]を省略した場合は、指定の環境へすべてのアプリをデプロイします。

[環境]と[アプリ名]の両方を指定した場合は指定の環境へ指定のアプリのみをデプロイします。

[アプリ名]を指定して[環境]を省略することはできません。1つ目の引数は環境とみなされます。


## 制限事項

- 例外処理等は手を抜いていますのでご注意。
- ファイルの適用範囲は常に「すべてのユーザーに適用」になります。
- 「PC用のJavaScriptファイル」「PC用のCSSファイル」のみに対応しています。「スマートフォン用のJavaScriptファイル」には対応していません。
- ファイルの変更有無にかかわらず、常にすべてのファイルがアップロードしなおされます。
- このスクリプトはあくまでも「出来上がったファイルを」デプロイするだけなので、ビルドは行いません。
    - なんらかのビルドタスク（CofferScriptのコンパイルとか、.jsのminimizeとか）がある場合は、deploy.rb を実行するより前に実施しておいてください。

## Author

Tomoya Iwata

## Contact

[R3 institute](https://www.r3it.com/)

## License

[Apache v2 License](http://www.apache.org/licenses/LICENSE-2.0.html)